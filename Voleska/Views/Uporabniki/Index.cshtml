@model PaginatedList<Voleska.Areas.Identity.Data.ApplicationUser>

@{
    ViewData["Title"] = "Uporabniki";
}

<nav aria-label="breadcrumb" class="">
    <ol class="breadcrumb bg-white d-flex justify-content-center">
        <li class="breadcrumb-item"><a asp-area="" asp-controller="Home" asp-action="Index" asp-route-izbira="domov" class="customColor">Domov</a></li>
        <li class="breadcrumb-item active">Uporabniki</li>
    </ol>
</nav>

<h1 class="text-center mb-3">Uporabniki</h1>

<div id="prenosPodatkovRole" class="no-display">
    @await Component.InvokeAsync(nameof(Voleska.ViewComponents.ViewComponents.PrenosPodatkovRoleVC), new { })
</div>



<div class="row">
    <div class="col-md-8">
        <form asp-controller="Uporabniki" asp-action="Index" method="get" class="d-flex">
            <div class="row d-flex mr-1">
                <div class="input-group md-form form-sm form-2 col-md-2 col-12">
                    <input class="p-2 col-12" type="text" id="SearchString" name="SearchString" value="@ViewBag.SearchString">
                    <label for="SearchString" class="ml-3">Uporabniško ime...</label>
                </div>

                <div class="input-group md-form form-sm form-2 col-md-2 col-12">
                    <input class="p-2 col-12" type="text" id="SearchString2" name="SearchString2" value="@ViewBag.SearchString2">
                    <label for="SearchString2" class="ml-3">E-naslov...</label>
                </div>
                <div class="input-group md-form form-sm form-2 col-md-2 col-12">
                    <input class="p-2  col-12" type="text" id="SearchString3" name="SearchString3" value="@ViewBag.SearchString3">
                    <label for="SearchString3" class="ml-3">Ime...</label>
                </div>
                <div class="input-group md-form form-sm form-2 col-md-2 col-12">
                    <input class="p-2 col-12" type="text" id="SearchString4" name="SearchString4" value="@ViewBag.SearchString4">
                    <label for="SearchString4" class="ml-3">Priimek...</label>
                </div>

                <input type="hidden" name="filtriranje" value="@ViewBag.Filtriranje" />

                <div class="input-group-append ml-1 ml-md-4 d-flex align-items-center col-md-3 col-12">
                    <button type="submit" class=" btn btn-outline-unique2 btn px-2 mx-0 d-flex align-items-center" style="display: inline-block; height: 45px;">
                        <span class="mr-1">Iskanje </span>  <i class="fa fa-search fa-lg" aria-hidden="true"></i>
                    </button>
                    @if (@ViewBag.SearchString != null || @ViewBag.SearchString2 != null || @ViewBag.SearchString3 != null || @ViewBag.SearchString4 != null)
                    {
                        <div><a asp-action="Index" asp-controller="Uporabniki" class="ml-2">Nazaj</a></div>
                    }

                </div>

            </div>

        </form>


    </div>


    <div class="col-md-4 d-flex align-items-center justify-content-end">
        <!-- Split button -->
        <div class="btn-group orderBy2 mb-3 mb-md-0">
            <a type="button" class="btn btn-outline-unique2" asp-action="Index" asp-controller="Uporabniki">

                @if (ViewBag.IzbranFilter == null)
                {
                    <span>Razvrščanje</span>
                }
                else
                {
                    <span>@ViewBag.IzbranFilter</span>
                }

            </a>

            <button type="button" class="btn btn-outline-unique2 dropdown-toggle px-3" data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false">
                <span class="sr-only">Toggle Dropdown</span>
            </button>

            <div class="dropdown-menu poravnaj z-depth-5 p-2">
                <a class="dropdown-item dropDownCustom hoverable waves-effect waves-light py-2" asp-action="Index" asp-controller="Uporabniki" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4">Privzeto</a>
                <a class="dropdown-item dropDownCustom hoverable waves-effect waves-light py-2" asp-action="Index" asp-controller="Uporabniki" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="datumPadajoce">Najnovejši</a>
                <a class="dropdown-item dropDownCustom hoverable waves-effect waves-light py-2" asp-action="Index" asp-controller="Uporabniki" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="datumNarascajoce">Najstarejši</a>
            </div>


        </div>

    </div>

</div>
@{
    var izbranaRola = "";
    <div class="table-responsive text-nowrap mb-4 z-depth-1 rounded">

        <table class="table table-striped table-hover m-0">
            <thead class="black text-white">
                <tr>
                    <th>
                        @Html.DisplayName("Uporabniško ime")
                    </th>

                    <th>
                        @Html.DisplayName("E-naslov")
                    </th>
                    <th>
                        @Html.DisplayName("Ime")
                    </th>
                    <th>
                        @Html.DisplayName("Priimek")
                    </th>
                    <th class="text-center">
                        @Html.DisplayName("Aktiven")
                    </th>

                    <th>
                        @Html.DisplayName("Naslov")
                    </th>
                    <th class="text-center">
                        @Html.DisplayName("Vloga")
                    </th>
                    <th></th>

                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td class="align-middle">
                            @Html.DisplayFor(modelItem => item.UserName)
                        </td>

                        <td class="align-middle">
                            @Html.DisplayFor(modelItem => item.Email)
                        </td>
                        <td class="align-middle">
                            @Html.DisplayFor(modelItem => item.Ime)
                        </td>
                        <td class="align-middle">
                            @Html.DisplayFor(modelItem => item.Priimek)
                        </td>
                        <td class="align-middle text-center">
                            @Html.DisplayFor(modelItem => item.Aktiven)
                        </td>

                        <td class="align-middle">
                            @Html.DisplayFor(modelItem => item.Naslov.Ulica)
                            @Html.DisplayFor(modelItem => item.Naslov.HisnaStevilka)
                        </td>

                        <td class="align-middle text-center">
                            @foreach (var role in item.UserRoles)
                            {

                                izbranaRola = @role.ApplicationRole.Id;
                            }
                            @{ 
                                var disabled = "";
                                var editColor = "";
                                var deleteColor = "";

                            }
                            @if (item.UserName == "TomazJaksa")
                            {
                                disabled = "disabled";
                                editColor = deleteColor = "light";
                            }
                            else {
                                disabled = "";
                                editColor = "success";
                                deleteColor = "danger";
                            }

                            <!-- Basic dropdown -->

                            <select class="browser-default custom-select @disabled" onchange="ajaxChangeRole(this);" id="selectRole-@item.Id">
                                @await Component.InvokeAsync(nameof(Voleska.ViewComponents.ViewComponents.VlogeVC), new { selectedRole = izbranaRola, userId = item.Id })

                            </select>
                            <!-- Basic dropdown -->
                            </td>
                        <td class="align-middle text-center">
                           
                                <a class="izbira btn-sm btn-outline-@editColor @disabled mr-2 " asp-action="Edit" asp-route-id="@item.Id" data-placement="left" data-toggle="tooltip" title="Uredi" asp-route-stevilkaStrani="@ViewBag.StevilkaStrani" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="@ViewBag.Filtriranje"><i class="fa fa-edit"></i></a>
                                <a class="izbira btn-sm btn-outline-primary mr-2 " asp-action="Details" asp-route-id="@item.Id" data-placement="bottom" data-toggle="tooltip" title="Podrobnosti" asp-route-stevilkaStrani="@ViewBag.StevilkaStrani" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="@ViewBag.Filtriranje"><i class="fas fa-info-circle"></i></a>
                                <a class="izbira btn-sm btn-outline-@deleteColor @disabled mr-2 " asp-action="Delete" asp-route-id="@item.Id" data-placement="right" data-toggle="tooltip" title="Izbriši" asp-route-stevilkaStrani="@ViewBag.StevilkaStrani" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="@ViewBag.Filtriranje"><i class="fa fa-trash"></i></a>

                        </td>
                    </tr>
                }
            </tbody>
        </table>



    </div>
}
@{

    var prejsnjaStran = 1;


    if (ViewBag.StevilkaStrani != null)
    {
        prejsnjaStran = ViewBag.StevilkaStrani - 1;
    }
    var naslednjaStran = ViewBag.StevilkaStrani + 1;

    if (ViewBag.StevilkaStrani == null)
    {
        naslednjaStran = 2;
    }

    var izklopi = "";

    <nav aria-label="Page navigation example">
        <ul class="pagination pg-teal">
            @if (!@Model.HasPreviousPage)
            {
                izklopi = "text-muted izklopi";
            }
            <li class="page-item">
                <a class="pl-0 page-link @izklopi" asp-route-stevilkaStrani="@prejsnjaStran" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="@ViewBag.Filtriranje">Nazaj</a>
            </li>
            @for (var i = 1; i <= Model.TotalPages; i++)
            {
                if (i == @Model.PageIndex)
                {
                    <li class="page-item active">
                        <a class="page-link" asp-route-kliknjenLinkStrani="@i" asp-route-stevilkaStrani="@i" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="@ViewBag.Filtriranje">@i <span class="sr-only">(current)</span></a>
                    </li>
                }
                else
                {
                    <li class="page-item"><a class="page-link" asp-route-kliknjenLinkStrani="@i" asp-route-stevilkaStrani="@i" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="@ViewBag.Filtriranje">@i</a></li>
                }



            }

            @if (@Model.HasNextPage)
            {
                izklopi = "";
            }
            else
            {
                izklopi = "text-muted izklopi";
            }
            <li class="page-item ">
                <a class="page-link @izklopi" asp-route-stevilkaStrani="@naslednjaStran" asp-route-searchString="@ViewBag.SearchString" asp-route-searchString2="@ViewBag.SearchString2" asp-route-searchString3="@ViewBag.SearchString3" asp-route-searchString4="@ViewBag.SearchString4" asp-route-filtriranje="@ViewBag.Filtriranje">Naprej</a>
            </li>
        </ul>
    </nav>

}

<p class="d-flex">
    <a class="nav-link pl-0 customColor" asp-area="" asp-controller="Administration" asp-action="Index"><i class="far fa-address-card mr-2"></i>Seznam vlog</a>
</p>


@section Scripts {
    <script>

@*VLOGE AJAX*@

                $(document).ready(function () {
                    $(function () {

                        $(".izbira").tooltip({
                            delay: { show: 0, hide: 0 },
                            trigger: 'hover'
                        });

                    })

                });


        function ajaxChangeRole(select) {

            var selectedOption = select.options[select.selectedIndex];

            var roleId = selectedOption.value;
            var userId = select.options[select.selectedIndex].getAttribute('data-userId');

            $.ajax({
                type: "POST",
                url: '@Url.Action("ChangeRole", "Administration")',
                data: {roleId: roleId, userId: userId},
                dataType: "html",
                success: function (data) {

                    $('#prenosPodatkovRole').html(data);

                    var rId = $('#prenosPodatkov').attr("asp-route-roleIdAjax");
                    var uId = $('#prenosPodatkov').attr("asp-route-userIdAjax");

                    ajaxRoleReload(rId, uId);

                },
                failure: function (data) {

                    alert("Fail!");
                },
                error: function (data) {
                    alert("Zašteku ful!");
                }

            });


        }

        function ajaxRoleReload(roleId, userId) {
            $.ajax({
                url: '@Url.Action("RoleReload", "Administration")',
                data: {roleId: roleId, userId: userId },
                success: function (data) {

                    $('#selectRole-' + userId).html(data);

                },
                failure: function (response) {
                    alert("Error v ajaxRoleReload");
                },
                error: function (response) {
                    alert("Error v ajaxRoleReload");
                }
            });
        };


    </script>
}
